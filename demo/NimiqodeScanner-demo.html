<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nimiqode Scanner Demo</title>
    <script src="../src/Camera.js"></script>
    <script src="../src/GrayscaleImage.js"></script>
    <script src="../src/Binarizer.js"></script>
    <script src="../src/NimiqodeDetector.js"></script>
    <script src="../src/BoundingRectDetector.js"></script>
    <script src="../src/BoundingHexagonDetector.js"></script>
    <script src="../src/HexagonRingDetector.js"></script>
    <script src="../src/Point.js"></script>
    <script src="../src/DebugRenderUtils.js"></script>
</head>
<body>
<style>
    @media (min-width: 1200px) {
        #container {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
    }
</style>
<div id="container">
    <video id="video"></video><br>
    <div>
        <canvas id="grayscale"></canvas>
        <canvas id="convex-hull"></canvas>
        <canvas id="bounding-hexagon"></canvas>
        <canvas id="hexagon-rings"></canvas>
    </div>
</div>
<script>
    const grayscaleCanvas = document.getElementById('grayscale');
    const grayscaleContext = grayscaleCanvas.getContext('2d');
    const convexHullCanvas = document.getElementById('convex-hull');
    const convexHullContext = convexHullCanvas.getContext('2d');
    const boundingHexagonCanvas = document.getElementById('bounding-hexagon');
    const boundingHexagonContext = boundingHexagonCanvas.getContext('2d');
    const hexagonRingsCanvas = document.getElementById('hexagon-rings');
    const hexagonRingsContext = hexagonRingsCanvas.getContext('2d');
    const camera = new Camera(document.getElementById('video'));
    let imageBuffer;

    function debugCallback(eventType, data) {
        if (eventType === 'grayscale-image') {
            grayscaleContext.putImageData(data.exportToRgba(imageBuffer), 0, 0);
        } else if (eventType === 'binary-image') {
            const imageData = data.exportToRgba(imageBuffer);
            convexHullContext.putImageData(imageData, 0, 0);
            boundingHexagonContext.putImageData(imageData, 0, 0);
            hexagonRingsContext.putImageData(imageData, 0, 0);
        } else if (eventType === 'bounding-rect') {
            convexHullContext.strokeStyle = 'blue';
            DebugRenderUtils.renderBoundingRect(data, convexHullContext);
        } else if (eventType === 'convex-hull-candidates') {
            convexHullContext.fillStyle = 'red';
            DebugRenderUtils.renderPoints(data, convexHullContext);
        } else if (eventType === 'convex-hull') {
            convexHullContext.strokeStyle = 'cyan';
            convexHullContext.fillStyle = 'green';
            DebugRenderUtils.renderPolygon(data, convexHullContext);
        } else if (eventType === 'longest-convex-hull-sides') {
            boundingHexagonContext.strokeStyle = 'cyan';
            boundingHexagonContext.lineWidth = 3;
            boundingHexagonContext.fillStyle = 'green';
            DebugRenderUtils.renderLines(data, boundingHexagonContext);
        } else if (eventType === 'bounding-hexagon') {
            boundingHexagonContext.strokeStyle = 'blue';
            boundingHexagonContext.lineWidth = 1;
            boundingHexagonContext.fillStyle = 'red';
            DebugRenderUtils.renderBoundingHexagon(data, boundingHexagonContext);
        } else if (eventType === 'orientation-finder') {
            hexagonRingsContext.strokeStyle = 'cyan';
            DebugRenderUtils.renderLines(data, hexagonRingsContext);
        }
    }

    function process() {
        if (camera.isFilming) {
            const snapshot = camera.takeSnapshot();
            try {
                NimiqodeDetector.detect(snapshot, debugCallback);
            } catch(e) {
                if (e.message.startsWith('Not found.')) {
                    console.log(e.message);
                } else {
                    throw e;
                }
            }
        }
        requestAnimationFrame(process);
    }

    camera.start().then(() => {
        const width = camera.dimensions.width, height = camera.dimensions.height;
        grayscaleCanvas.width = width;
        grayscaleCanvas.height = height;
        convexHullCanvas.width = width;
        convexHullCanvas.height = height;
        boundingHexagonCanvas.width = width;
        boundingHexagonCanvas.height = height;
        hexagonRingsCanvas.width = width;
        hexagonRingsCanvas.height = height;
        imageBuffer = new Uint8ClampedArray(width * height * 4); // 4 byte per pixel
        process();
    });
</script>
</body>
</html>